逐次モデル改善方針メモ
================================================================

現状の成果
- FeatureState による逐次ラグ更新と XGBoost 前進推論を導入し、初月と以降月の分断はほぼ解消。例：A01101A の MAPE が 71% → 35%、精度 64.6%。
- ただし総量過大 (月平均比 1.24) や、極小実績日に対する過大予測が残存。全体MAPE は 194% と高く、ゼロ近傍需要の扱いが課題。

追加改善方針
1. 低実績日・ゼロ需要対策
   - FeatureState の派生特徴を活用して減衰重みを導入。`days_since_last_nonzero_f` や `recent_nonzero_ratio_*` をもとに、推論時に予測値へ指数減衰係数をかける仕組みを検討。
   - 月次再スケーリングを再設計。直近 12 ヶ月の月別総量をベースラインとし、低実績期間では上限を1.05倍程度に制限、繁忙期には volume_segment と連動させて柔軟に調整。
   - 小規模需要の扱いを明示：実績が一定閾値（例：10）未満かつ連続低位が続く場合は、ヒューリスティックに min(予測, ヒストリ平均) を適用するフォールバックを用意。

2. モニタリング指標の強化
   - MAPE だけでなく WAPE (Σ|予測-実績| / Σ実績) を主要評価指標に追加し、総量バイアスを早期検知。
   - 各商品について horizon別 MAPE / WAPE / RMSE を計算し、閾値（例：MAPE > 120% または WAPE > 0.6）を超えた商品コードをウォッチリストとして抽出。`work/data/predictions` 配下に JSON/CSV を自動保存。
   - ウォッチリスト対象は可視化で自動ハイライト（ファイル名接尾辞 `_alert` 等）し、ドリルダウンしやすい導線を整備。

3. 今後の検証計画
   - 減衰ロジック導入後、2024年のローリング検証で WAPE / MAPE の推移を測定し、総量比が1.05以内に収まるか確認。
   - ゼロ需要日が多いカテゴリ（例：A153970 等）に対する個別分析を行い、フォールバック閾値をチューニング。
