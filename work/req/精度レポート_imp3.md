# imp3 精度分析メモ（2025/01-03 推定）

対象: `work/vis_2025-01_to_03_imp3`（学習: 〜2024/12、予測: 2025/01-03）

補助データ:  
- `work/script/tmp/imp3/out/material_metrics.csv`（SKUごとの特性集約）  
- `.../group_comparison_high_vs_low.csv`（精度上位/下位比較）  
- `.../segment_summary.csv`, `.../accuracy_bucket_summary.csv`  
- 散布図 `scatter_accuracy_vs_*.png`, 月次誤差 `monthly_overview.csv`

## 1. 全体スナップショット
- Accuracy 平均 50.1%（imp2 比 +0.5pt）、WAPE は 50.5%（+2.1pt）。総予測量は実績比 1.21 倍で過大傾向が強化。
- 月別集計（`monthly_overview.csv`）では 1〜3 月すべてで 16〜25% の過大予測が発生。特に 3 月は 1.25 倍。
- 相関分析（`correlation_matrix.csv`）より Accuracy を下げている要因は `pred_zero_share`（r=-0.72）、`pred_actual_cv`（r=-0.71）、`daily_cv`（r=-0.61）。一方で `nonzero_share`（r=+0.32）、`daily_mean`（r=+0.26）が高いほど精度が改善。

## 2. 高精度群 vs 低精度群（四分位比較）
`group_comparison_high_vs_low.csv`（上位25% vs 下位25%）より:

| 指標 | 上位25% | 下位25% | 差分 (High-Low) | 所感 |
| --- | --- | --- | --- | --- |
| Accuracy | 67.5% | 26.3% | +41.2pt | 明確な分離。 |
| WAPE | 37.1% | 125.7% | -88.6pt | 下位群は誤差が3倍超。 |
| 予測/実績比 | 1.06 | 1.45 | -0.39 | 下位群は大幅に過大。 |
| 日次平均 | 491 | 65.6 | +425 | ボリューム差が約7.5倍。 |
| 日次CV | 1.15 | 1.97 | -0.82 | ボラティリティの高さが精度を大きく左右。 |
| 月次CV | 0.42 | 0.58 | -0.16 | 月間でも下位群は変動大。 |
| Seasonality Ratio | 2.68 | 3.81 | -1.13 | ピーク依存の強い SKU が低精度側に集中。 |
| 予測期ゼロ日率 | 37% | 47% | -10pt | ゼロ日の多さが予測難度に直結。 |
| `segment_high_volume` | 92% | 36% | +56pt | 精度上位は高ボリューム枠が大半。 |
| `segment_low_volume` | 12% | 48% | -36pt | 低ボリュームSKUが低精度側に偏在。 |
| `segment_spiky` | 20% | 52% | -32pt | スパイク型SKUでの劣化が顕著。 |

> 備考: `longest_zero_run` は上位群の方が大きい（36日 vs 23日）。高精度の一部に長期欠測を抱えるが、非ゼロ比率が高いため補足できていると考えられる。

## 3. セグメント別の傾向（`segment_summary.csv`）
- **HighVolume (65件)**: Accuracy 平均 55.5%、WAPE 58.9%。それでも過大予測が平均 1.16 倍存在。高ボリュームでも一部 SKU は精度が伸びていない。
- **LowVolume (30件)**: Accuracy 41.9%、WAPE 92.6%。非ゼロ率が低く、季節指数も 4.1 と高い。ゼロ日制御の改善が最優先。
- **Spiky (30件)**: Accuracy 43.2%、WAPE 87.0%、seasonality ratio 5.96。ピーク検知と縮小ロジックの強化余地あり。
- **LongGap (26件)**: Accuracy 53.9%、WAPE 60.6%。`long_gap_flag` 単独では精度を大きく毀損していないが、ボラティリティが高く過大予測寄り。

Accuracy バケット別にも `<40%` グループで `pred_ratio`=1.48、`daily_cv`=2.09、`pred_zero_share`=0.49 と悪化要因が集中。

## 4. 個別 SKU の観察
- **高精度●低ボリューム**: A153970 (Accuracy 71.5%)、A145570 (70.2%) などは `longest_zero_run` が 95〜116 日でも安定。ゼロ確率特徴の効果が現れた例。
- **高ボリューム低精度**: A067414 (3.1%)、A175080 (15.6%)、A108910 (46.4%) 等。いずれも `segment_high_volume=1` だが `seasonality_ratio` 3〜10、`pred_ratio` 1.4〜3.9 と過大予測が顕著。  
  - 特に A067414: 日次平均 603、`pred_zero_share` 0.61。ゼロ日の取り扱いが不十分で、スパイクも多発。
- **低ボリューム低精度**: A181930 (accuracy 4.6、pred_ratio 3.97)、A186710 (5.2、ゼロ率 0.72)。ゼロ連続の長さは捕捉できているが、数量縮小が追いついていない。

散布図からも `daily_mean` が小さい領域（特に <100）で Accuracy が大きくばらつき、`pred_ratio` の色が濃い（>1.2）ほど Accuracy が落ちることが確認できる。

## 5. 今後の検討ポイント
1. **ゼロ日判定の精緻化（特に高ボリューム SKU）**  
   - `pred_zero_share` と Accuracy の負の相関が顕著。高ボリューム SKU 向けにゼロ確率の上限（現状0.6）を抑制、または週末効果を分離した閾値補正が必要。
   - 過大予測を起こしている A067414 / A175080 / A108910 などでゼロ推定プロファイルを再確認する。

2. **ボラティリティの高い SKU 向けの縮小ロジック**  
   - 下位群では `pred_actual_cv` が 1.98 と 2倍超。現在のトレンド補正だけでは不十分なため、外れ値クラッピングやプロモーション検知の追加を検討。

3. **低ボリューム・高長期ゼロ SKU の二段構えモデル**  
   - `segment_low_volume` グループは Accuracy 41.9%、WAPE 92.6%。ゼロ判定→数量予測の分割学習や `long_gap_flag` に基づく縮小係数の導入が有効と考えられる。

4. **月別の予測過大（特に 3 月）への対応**  
   - 月別 `pred_ratio` が 1.16〜1.25。季節性ピークの見積もりが過大になっているため、3月向けのシーズン調整（例えば `seasonality_ratio` が高い SKU へのペナルティ）を設ける。

5. **優先調査リストの抽出**  
   - 高ボリュームかつ Accuracy<55% の 26 SKU（`material_metrics.csv` 参照）は事業インパクトが大きい。特に A067414 / A175080 / A012150 / A108910 を優先し、実績波形と特徴量の寄与度をレビューする。

## 6. 次アクション案
- `work/script/tmp/imp3/out/material_metrics.csv` を基に対象 SKU リストをプロダクトチームと共有し、需要変動のイベント有無をヒアリング。
- ゼロ確率調整および高ボリューム向け縮小ロジックの PoC を `work/script/tmp/imp3` 配下で試作 → 再学習・再可視化へ展開。
- 継続的に `scatter_accuracy_vs_*` グラフを更新し、モデル変更の効果検証を簡易に行えるよう備える。
